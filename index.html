<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0c0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="My Day">
<link rel="manifest" href="/manifest.json">
<title>My Day</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body,#root{height:100%;background:#0c0f1a;font-family:'SF Pro Display',-apple-system,'Segoe UI',sans-serif;-webkit-font-smoothing:antialiased;color:#e2e8f0;overflow-x:hidden}
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
input,select,textarea,button{font-family:inherit}
::-webkit-scrollbar{width:0;height:0}
.sync-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px}
.sync-on{background:#10b981;box-shadow:0 0 6px rgba(16,185,129,0.5)}
.sync-off{background:#ef4444;box-shadow:0 0 6px rgba(239,68,68,0.5)}
</style>
</head>
<body>
<div id="root"></div>

<!-- React -->
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// â•â•â• FIREBASE SETUP â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyAfMcI-3cIwWz1AlrkmisqNuZvcJ7wUfP4",
  authDomain: "dayone-14927.firebaseapp.com",
  databaseURL: "https://dayone-14927-default-rtdb.firebaseio.com",
  projectId: "dayone-14927",
  storageBucket: "dayone-14927.firebasestorage.app",
  messagingSenderId: "775317638738",
  appId: "1:775317638738:web:46bd112241356da613198b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dataRef = db.ref('routineApp');

// â•â•â• SERVICE WORKER â•â•â•
let swReg = null;
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(r => { swReg = r; }).catch(e => console.log('SW:', e));
}

function showSWNotification(title, body, tag) {
  if (swReg) {
    try { swReg.showNotification(title, { body, tag: tag||'myday', renotify:true, vibrate:[200,100,200], requireInteraction:true }); } catch(e){}
  } else if ('Notification' in window && Notification.permission === 'granted') {
    try { new Notification(title, { body, tag: tag||'myday' }); } catch(e){}
  }
}

// â•â•â• CONSTANTS â•â•â•
const LOCAL_KEY = 'routine-app-sync-v1';
const DAYS = ['sun','mon','tue','wed','thu','fri','sat'];
const DAY_LABELS = {sun:'S',mon:'M',tue:'T',wed:'W',thu:'T',fri:'F',sat:'S'};
const DAY_FULL = {sun:'Sun',mon:'Mon',tue:'Tue',wed:'Wed',thu:'Thu',fri:'Fri',sat:'Sat'};
const ALL_DAYS = [...DAYS];
const todayDow = () => DAYS[new Date().getDay()];
const todayISO = () => { const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); };
const getNow = () => { const d=new Date(); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); };
const toMin = (t) => { const p=t.split(':').map(Number); return p[0]*60+p[1]; };
const genId = () => 't'+Date.now()+Math.random().toString(36).slice(2,6);

const DEFAULT_TASKS = [
  {id:'t1',name:'Desayuno',category:'core',project:'',notes:'',timeCondition:{time:'07:20',labelBefore:'Desayuno en casa',labelAfter:'Desayuno ofi'},dependsOn:null,activeDays:[...ALL_DAYS],eventDates:[],archived:false,order:0},
  {id:'t2',name:'Almuerzo',category:'core',project:'',notes:'',timeCondition:{time:'12:30',labelBefore:null,labelAfter:null},dependsOn:null,activeDays:[...ALL_DAYS],eventDates:[],archived:false,order:1},
  {id:'t3',name:'Cena',category:'core',project:'',notes:'',timeCondition:{time:'20:00',labelBefore:null,labelAfter:null},dependsOn:null,activeDays:[...ALL_DAYS],eventDates:[],archived:false,order:2},
  {id:'t4',name:'Completar PPT mina MutÃºn',category:'work',project:'MutÃºn Mining',notes:'Revisar slides 5-8',timeCondition:null,dependsOn:null,activeDays:[...ALL_DAYS],eventDates:[],archived:false,order:3},
  {id:'t5',name:'Revisar plataforma TIKR',category:'work',project:'Research',notes:'',timeCondition:null,dependsOn:null,activeDays:['mon','wed','fri'],eventDates:[],archived:false,order:4},
  {id:'t6',name:'Repaso CFA',category:'personal',project:'CFA Level I',notes:'CapÃ­tulo 12: Fixed Income',timeCondition:null,dependsOn:null,activeDays:['mon','tue','wed','thu','fri'],eventDates:[],archived:false,order:5},
  {id:'t7',name:'Ruta Nuzlocke en Cobblemon',category:'personal',project:'Gaming',notes:'',timeCondition:null,dependsOn:null,activeDays:['sat','sun'],eventDates:[],archived:false,order:6},
  {id:'t8',name:'ReuniÃ³n equipo MutÃºn',category:'event',project:'MutÃºn Mining',notes:'Sala 3B',timeCondition:{time:'10:00',labelBefore:null,labelAfter:null},dependsOn:null,activeDays:[],eventDates:[todayISO()],archived:false,order:7},
];

const CAT = {
  core:{bg:'rgba(251,191,36,0.12)',border:'#f59e0b',text:'#fbbf24',label:'Core'},
  event:{bg:'rgba(244,63,94,0.12)',border:'#f43f5e',text:'#fb7185',label:'Event'},
  work:{bg:'rgba(59,130,246,0.12)',border:'#3b82f6',text:'#60a5fa',label:'Work'},
  personal:{bg:'rgba(168,85,247,0.12)',border:'#a855f7',text:'#c084fc',label:'Personal'},
};

// â•â•â• DATA LAYER â€” Firebase + localStorage fallback â•â•â•
function saveLocal(data) { try { localStorage.setItem(LOCAL_KEY, JSON.stringify(data)); } catch(e){} }
function loadLocal() { try { const s=localStorage.getItem(LOCAL_KEY); return s?JSON.parse(s):null; } catch(e){ return null; } }

function saveToFirebase(data) {
  try { dataRef.set(data); } catch(e) { console.log('Firebase write failed, offline?'); }
}

const h = React.createElement;
const {useState,useEffect,useCallback,useRef} = React;

// â•â•â• ICONS â•â•â•
const Ic={
  Sun:()=>h('svg',{width:20,height:20,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('circle',{cx:12,cy:12,r:5}),h('line',{x1:12,y1:1,x2:12,y2:3}),h('line',{x1:12,y1:21,x2:12,y2:23}),h('line',{x1:4.22,y1:4.22,x2:5.64,y2:5.64}),h('line',{x1:18.36,y1:18.36,x2:19.78,y2:19.78}),h('line',{x1:1,y1:12,x2:3,y2:12}),h('line',{x1:21,y1:12,x2:23,y2:12}),h('line',{x1:4.22,y1:19.78,x2:5.64,y2:18.36}),h('line',{x1:18.36,y1:5.64,x2:19.78,y2:4.22})),
  Brief:()=>h('svg',{width:20,height:20,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('rect',{x:2,y:7,width:20,height:14,rx:2,ry:2}),h('path',{d:'M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16'})),
  Cal:()=>h('svg',{width:20,height:20,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('rect',{x:3,y:4,width:18,height:18,rx:2,ry:2}),h('line',{x1:16,y1:2,x2:16,y2:6}),h('line',{x1:8,y1:2,x2:8,y2:6}),h('line',{x1:3,y1:10,x2:21,y2:10})),
  Gear:()=>h('svg',{width:20,height:20,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('circle',{cx:12,cy:12,r:3}),h('path',{d:'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'})),
  Plus:()=>h('svg',{width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2.5,strokeLinecap:'round'},h('line',{x1:12,y1:5,x2:12,y2:19}),h('line',{x1:5,y1:12,x2:19,y2:12})),
  Edit:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7'}),h('path',{d:'M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z'})),
  Trash:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'3 6 5 6 21 6'}),h('path',{d:'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'})),
  Lock:()=>h('svg',{width:14,height:14,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('rect',{x:3,y:11,width:18,height:11,rx:2,ry:2}),h('path',{d:'M7 11V7a5 5 0 0 1 10 0v4'})),
  Clock:()=>h('svg',{width:14,height:14,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('circle',{cx:12,cy:12,r:10}),h('polyline',{points:'12 6 12 12 16 14'})),
  Check:()=>h('svg',{width:18,height:18,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:3,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'20 6 9 17 4 12'})),
  CheckBig:()=>h('svg',{width:28,height:28,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:3,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'20 6 9 17 4 12'})),
  X:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('line',{x1:18,y1:6,x2:6,y2:18}),h('line',{x1:6,y1:6,x2:18,y2:18})),
  Up:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'18 15 12 9 6 15'})),
  Down:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'6 9 12 15 18 9'})),
  Moon:()=>h('svg',{width:18,height:18,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z'})),
  Focus:()=>h('svg',{width:22,height:22,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('circle',{cx:12,cy:12,r:10}),h('circle',{cx:12,cy:12,r:6}),h('circle',{cx:12,cy:12,r:2})),
  Bell:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9'}),h('path',{d:'M13.73 21a2 2 0 0 1-3.46 0'})),
  BellOff:()=>h('svg',{width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M13.73 21a2 2 0 0 1-3.46 0'}),h('path',{d:'M18.63 13A17.89 17.89 0 0 1 18 8'}),h('path',{d:'M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14'}),h('path',{d:'M18 8a6 6 0 0 0-9.33-5'}),h('line',{x1:1,y1:1,x2:23,y2:23})),
  Note:()=>h('svg',{width:14,height:14,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'}),h('polyline',{points:'14 2 14 8 20 8'}),h('line',{x1:16,y1:13,x2:8,y2:13}),h('line',{x1:16,y1:17,x2:8,y2:17})),
  Archive:()=>h('svg',{width:14,height:14,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'21 8 21 21 3 21 3 8'}),h('rect',{x:1,y:3,width:22,height:5}),h('line',{x1:10,y1:12,x2:14,y2:12})),
};

// â•â•â• STYLES â•â•â•
const F="'SF Pro Display',-apple-system,'Segoe UI',sans-serif";
const S={
  root:{fontFamily:F,background:'#0c0f1a',minHeight:'100vh',maxWidth:480,margin:'0 auto',position:'relative',color:'#e2e8f0',WebkitFontSmoothing:'antialiased'},
  loadWrap:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100vh',background:'#0c0f1a',fontFamily:F},
  banner:{position:'fixed',top:0,left:'50%',transform:'translateX(-50%)',width:'100%',maxWidth:480,background:'linear-gradient(135deg,#f59e0b,#d97706)',color:'#0c0f1a',padding:'14px 16px',display:'flex',alignItems:'center',gap:10,zIndex:300,fontFamily:F,boxShadow:'0 4px 20px rgba(245,158,11,0.4)',paddingTop:'calc(14px + env(safe-area-inset-top))'},
  bannerTxt:{flex:1,fontSize:14,fontWeight:700},bannerX:{background:'none',border:'none',color:'#0c0f1a',cursor:'pointer',padding:4,display:'flex'},
  header:{padding:'16px 20px 12px',background:'linear-gradient(180deg,#0c0f1a 0%,rgba(12,15,26,0.95) 100%)',position:'sticky',top:0,zIndex:50,backdropFilter:'blur(20px)',borderBottom:'1px solid rgba(148,163,184,0.06)',display:'flex',alignItems:'center',gap:12},
  hTitle:{fontSize:22,fontWeight:700,letterSpacing:'-0.02em',color:'#f8fafc'},hTime:{fontSize:14,color:'#64748b',fontWeight:500,fontVariantNumeric:'tabular-nums'},
  notifBtn:{background:'none',border:'none',cursor:'pointer',padding:6,display:'flex',alignItems:'center',borderRadius:8},
  content:{padding:'12px 16px',paddingBottom:90},
  tglTrack:{display:'flex',position:'relative',background:'#1e293b',borderRadius:14,padding:4,height:48},
  tglThumb:{position:'absolute',top:4,left:4,width:'calc(50% - 4px)',height:40,borderRadius:11,transition:'all .3s cubic-bezier(.4,0,.2,1)',zIndex:0},
  tglOpt:{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:8,fontSize:14,fontWeight:600,background:'none',border:'none',cursor:'pointer',zIndex:1,position:'relative',fontFamily:F,transition:'color .2s',color:'#94a3b8'},
  progWrap:{display:'flex',alignItems:'center',gap:10,marginBottom:16},progBg:{flex:1,height:6,background:'#1e293b',borderRadius:3,overflow:'hidden'},
  progFill:{height:'100%',borderRadius:3,transition:'width .5s cubic-bezier(.4,0,.2,1)'},progTxt:{fontSize:13,fontWeight:600,color:'#94a3b8',fontVariantNumeric:'tabular-nums',minWidth:32,textAlign:'right'},
  hero:{background:'linear-gradient(135deg,rgba(251,191,36,0.06) 0%,rgba(251,191,36,0.02) 100%)',border:'1px solid rgba(251,191,36,0.18)',borderRadius:20,padding:'24px 20px',marginBottom:8,boxShadow:'0 0 40px rgba(251,191,36,0.06),0 8px 32px rgba(0,0,0,0.3)',cursor:'pointer'},
  heroTop:{display:'flex',alignItems:'center',gap:8,color:'#f59e0b',marginBottom:12},heroLabel:{fontSize:12,fontWeight:800,letterSpacing:'0.1em',color:'#f59e0b'},
  heroName:{fontSize:26,fontWeight:800,color:'#fef3c7',lineHeight:1.2,letterSpacing:'-0.02em',marginBottom:10},
  heroMeta:{display:'flex',alignItems:'center',gap:8,marginBottom:18,flexWrap:'wrap'},heroProj:{fontSize:12,fontWeight:600,color:'#94a3b8',background:'rgba(148,163,184,0.1)',padding:'3px 10px',borderRadius:6},
  heroBtns:{display:'flex',gap:10},heroDone:{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:8,padding:'14px 20px',background:'linear-gradient(135deg,#10b981,#059669)',border:'none',borderRadius:14,color:'#fff',fontSize:16,fontWeight:700,cursor:'pointer',fontFamily:F,boxShadow:'0 4px 20px rgba(16,185,129,0.3)'},
  heroSkip:{display:'flex',alignItems:'center',justifyContent:'center',gap:6,padding:'14px 20px',background:'rgba(100,116,139,0.15)',border:'1px solid rgba(100,116,139,0.3)',borderRadius:14,color:'#94a3b8',fontSize:14,fontWeight:600,cursor:'pointer',fontFamily:F},
  secLabel:{fontSize:11,fontWeight:700,color:'#475569',textTransform:'uppercase',letterSpacing:'0.08em',marginBottom:8,padding:'0 4px'},
  card:{display:'flex',alignItems:'flex-start',gap:12,padding:'12px 14px',background:'#111827',borderRadius:12,borderLeft:'3px solid transparent',transition:'all .2s',cursor:'pointer'},cardDone:{opacity:0.45},cardLock:{opacity:0.4},
  cb:{width:32,height:32,borderRadius:9,border:'2px solid #334155',background:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0,marginTop:1,transition:'all .2s',color:'transparent',fontFamily:F},
  cbDone:{background:'linear-gradient(135deg,#10b981,#059669)',border:'2px solid #10b981',color:'#fff'},cbSkip:{background:'rgba(100,116,139,0.3)',border:'2px solid #475569',color:'#94a3b8'},cbLock:{border:'2px solid #1e293b',color:'#334155',cursor:'not-allowed'},
  tName:{fontSize:14,fontWeight:600,color:'#e2e8f0',lineHeight:1.3},tDone:{textDecoration:'line-through',color:'#64748b'},tSkipTxt:{textDecoration:'line-through',color:'#64748b',fontStyle:'italic'},
  badge:{fontSize:9,fontWeight:700,padding:'2px 6px',borderRadius:5,border:'1px solid',textTransform:'uppercase',letterSpacing:'0.05em',whiteSpace:'nowrap'},
  projLabel:{fontSize:11,color:'#64748b',marginTop:2,fontWeight:500},reason:{display:'flex',alignItems:'center',gap:4,fontSize:10,color:'#64748b',fontWeight:500},
  skipLbl:{display:'inline-block',marginTop:3,fontSize:10,fontWeight:600,color:'#64748b',fontStyle:'italic'},
  skipBtn:{width:30,height:30,borderRadius:7,border:'1px solid rgba(100,116,139,0.3)',background:'rgba(100,116,139,0.1)',color:'#64748b',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0,marginTop:1,fontFamily:F},
  endBtn:{display:'flex',alignItems:'center',justifyContent:'center',gap:10,width:'100%',padding:14,marginTop:24,background:'linear-gradient(135deg,#1e293b,#0f172a)',border:'1px solid rgba(251,191,36,0.2)',borderRadius:14,color:'#fbbf24',fontSize:15,fontWeight:700,cursor:'pointer',fontFamily:F,letterSpacing:'0.02em'},
  nav:{position:'fixed',bottom:0,left:'50%',transform:'translateX(-50%)',width:'100%',maxWidth:480,display:'flex',background:'rgba(12,15,26,0.95)',backdropFilter:'blur(20px)',borderTop:'1px solid rgba(148,163,184,0.06)',zIndex:100,padding:'6px 0',paddingBottom:'calc(6px + env(safe-area-inset-bottom))'},
  navBtn:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:3,padding:'10px 0',background:'none',border:'none',color:'#475569',cursor:'pointer',fontFamily:F,transition:'color .2s'},navAct:{color:'#f59e0b'},navLbl:{fontSize:11,fontWeight:600,letterSpacing:'0.02em'},
  aCatHead:{display:'flex',alignItems:'center',gap:8,fontSize:13,fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em',marginBottom:10,padding:'0 4px'},
  aCatNote:{fontSize:10,fontWeight:500,color:'#475569',fontStyle:'italic',textTransform:'none',letterSpacing:0,marginLeft:6},
  aCard:{display:'flex',alignItems:'center',gap:10,padding:'12px 14px',background:'#111827',borderRadius:12,borderLeft:'3px solid transparent',marginBottom:6},aName:{fontSize:14,fontWeight:600,color:'#e2e8f0'},
  aMeta:{display:'flex',alignItems:'center',gap:4,fontSize:11,color:'#64748b',fontWeight:500},
  aBtn:{width:30,height:30,display:'flex',alignItems:'center',justifyContent:'center',background:'#1e293b',border:'none',borderRadius:8,color:'#94a3b8',cursor:'pointer',fontFamily:F},
  fab:{position:'fixed',bottom:80,right:'calc(50% - 220px)',width:56,height:56,borderRadius:16,background:'linear-gradient(135deg,#f59e0b,#d97706)',border:'none',color:'#0c0f1a',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',boxShadow:'0 8px 30px rgba(245,158,11,0.3)',zIndex:90,fontFamily:F},
  archiveToggle:{display:'flex',alignItems:'center',gap:8,width:'100%',padding:'12px 14px',background:'#111827',border:'1px solid #1e293b',borderRadius:12,color:'#64748b',fontSize:13,fontWeight:600,cursor:'pointer',fontFamily:F,marginBottom:8},
  overlay:{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',backdropFilter:'blur(4px)',display:'flex',alignItems:'flex-end',justifyContent:'center',zIndex:200,padding:16},
  modal:{width:'100%',maxWidth:440,background:'#1e293b',borderRadius:20,padding:'24px 20px',maxHeight:'85vh',overflow:'auto',marginBottom:'env(safe-area-inset-bottom,0px)'},
  mTitle:{fontSize:18,fontWeight:700,color:'#f8fafc',margin:'0 0 20px'},
  fLabel:{display:'block',fontSize:12,fontWeight:700,color:'#94a3b8',textTransform:'uppercase',letterSpacing:'0.06em',marginBottom:6,marginTop:16},
  fLabelSm:{display:'block',fontSize:11,fontWeight:600,color:'#64748b',marginBottom:4,marginTop:10},fHint:{fontSize:11,color:'#64748b',marginTop:6,fontStyle:'italic',padding:'0 2px'},
  fInput:{width:'100%',padding:'12px 14px',background:'#0f172a',border:'1px solid #334155',borderRadius:10,color:'#e2e8f0',fontSize:14,fontFamily:F,outline:'none',boxSizing:'border-box'},
  fSel:{width:'100%',padding:'12px 14px',background:'#0f172a',border:'1px solid #334155',borderRadius:10,color:'#e2e8f0',fontSize:14,fontFamily:F,outline:'none',boxSizing:'border-box',WebkitAppearance:'none'},
  miniTgl:{width:44,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',padding:0,transition:'background .2s'},
  miniTh:{width:20,height:20,borderRadius:10,background:'#fff',position:'absolute',top:2,transition:'transform .2s'},
  fCancel:{flex:1,padding:14,background:'#0f172a',border:'1px solid #334155',borderRadius:12,color:'#94a3b8',fontSize:14,fontWeight:600,cursor:'pointer',fontFamily:F},
  fSave:{flex:1,padding:14,background:'linear-gradient(135deg,#f59e0b,#d97706)',border:'none',borderRadius:12,color:'#0c0f1a',fontSize:14,fontWeight:700,cursor:'pointer',fontFamily:F},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const [tasks,setTasks]=useState([]);
  const [completed,setCompleted]=useState({});
  const [skipped,setSkipped]=useState({});
  const [tab,setTab]=useState('day');
  const [mode,setMode]=useState('work');
  const [ct,setCt]=useState(getNow());
  const [loading,setLoading]=useState(true);
  const [editing,setEditing]=useState(null);
  const [viewing,setViewing]=useState(null);
  const [confirmEnd,setConfirmEnd]=useState(false);
  const [confirmDel,setConfirmDel]=useState(null);
  const [notifOn,setNotifOn]=useState(false);
  const [banner,setBanner]=useState(null);
  const [showArchived,setShowArchived]=useState(false);
  const [synced,setSynced]=useState(false);
  const notified=useRef(new Set());
  const init=useRef(false);
  const skipNextFirebase=useRef(false);

  // â•â•â• LOAD: try Firebase first, fallback to local â•â•â•
  useEffect(()=>{
    if(init.current)return;init.current=true;

    // Listen to Firebase for realtime sync
    dataRef.on('value',(snap)=>{
      const val=snap.val();
      if(!val)return;
      if(skipNextFirebase.current){skipNextFirebase.current=false;return;}
      if(val.tasks)setTasks(prev=>{
        // Auto-archive past events
        return val.tasks.map(t=>{
          if(t.category==='event'&&!t.archived&&t.eventDates&&t.eventDates.length>0){
            if(t.eventDates.every(d=>d<todayISO()))return{...t,archived:true};
          }
          return t;
        });
      });
      if(val.completed)setCompleted(val.completed);
      if(val.skipped)setSkipped(val.skipped);
      if(val.notified)notified.current=new Set(val.notified);
      saveLocal(val);
      setSynced(true);
      if(loading)setLoading(false);
    },()=>{
      // Firebase offline â€” load from local
      console.log('Firebase offline, using local data');
      setSynced(false);
      const local=loadLocal();
      if(local&&local.tasks){setTasks(local.tasks);setCompleted(local.completed||{});setSkipped(local.skipped||{});if(local.notified)notified.current=new Set(local.notified);}
      else{setTasks(DEFAULT_TASKS);const d={tasks:DEFAULT_TASKS,completed:{},skipped:{},notified:[]};saveLocal(d);saveToFirebase(d);}
      if(loading)setLoading(false);
    });

    // Also check if we have local data for instant load
    const local=loadLocal();
    if(local&&local.tasks){setTasks(local.tasks);setCompleted(local.completed||{});setSkipped(local.skipped||{});setLoading(false);}

    if('Notification' in window&&Notification.permission==='granted')setNotifOn(true);

    // Connection state
    db.ref('.info/connected').on('value',(snap)=>{setSynced(!!snap.val());});
  },[]);

  // â•â•â• SAVE: to both Firebase and local â•â•â•
  const saveAll=useCallback((t,c,sk)=>{
    const data={tasks:t,completed:c,skipped:sk,notified:[...notified.current],lastUpdated:Date.now()};
    saveLocal(data);
    skipNextFirebase.current=true;
    saveToFirebase(data);
  },[]);

  useEffect(()=>{if(!loading)saveAll(tasks,completed,skipped);},[tasks,completed,skipped,loading]);

  // â•â•â• CLOCK + NOTIFICATIONS â•â•â•
  useEffect(()=>{
    const tick=()=>{
      const t=getNow();setCt(t);if(!notifOn)return;
      const nowMin=toMin(t);const today=todayISO();
      tasks.forEach(task=>{
        if(task.category!=='core'&&task.category!=='event')return;
        if(!task.timeCondition||notified.current.has(task.id))return;
        if(completed[task.id]||skipped[task.id]||task.archived)return;
        if(task.category==='core'&&!(task.activeDays||[]).includes(todayDow()))return;
        if(task.category==='event'&&!(task.eventDates||[]).includes(today))return;
        const tMin=toMin(task.timeCondition.time);
        if(nowMin>=tMin&&nowMin<=tMin+1){
          const dn=task.timeCondition.labelAfter||task.name;
          showSWNotification(task.category==='event'?'ðŸ“… Event':'â° Core',dn+' â€” Time to go!',task.id);
          setBanner(dn);setTimeout(()=>setBanner(null),5000);
          notified.current.add(task.id);
        }
      });
    };
    tick();const iv=setInterval(tick,15000);return()=>clearInterval(iv);
  },[tasks,completed,skipped,notifOn]);

  const reqNotif=async()=>{
    if(!('Notification' in window)){setBanner('Not supported');setTimeout(()=>setBanner(null),3000);return;}
    const p=await Notification.requestPermission();
    if(p==='granted'){setNotifOn(true);showSWNotification('ðŸ”” On','Notifications enabled');}
    else{setBanner('Permission denied');setTimeout(()=>setBanner(null),3000);}
  };

  // â•â•â• LOGIC â•â•â•
  const resolved=useCallback(id=>!!completed[id]||!!skipped[id],[completed,skipped]);
  const today=todayISO();const dow=todayDow();
  const isActive=useCallback(t=>{if(t.archived)return false;if(t.category==='event')return(t.eventDates||[]).includes(today);return(t.activeDays||ALL_DAYS).includes(dow);},[today,dow]);
  const coreEvt=tasks.filter(t=>(t.category==='core'||t.category==='event')&&isActive(t));
  const timeOk=useCallback(t=>!t.timeCondition||toMin(ct)>=toMin(t.timeCondition.time),[ct]);
  const depOk=useCallback(task=>{
    if(task.dependsOn&&!resolved(task.dependsOn))return false;
    if(task.category==='work'||task.category==='personal'){if(coreEvt.filter(c=>timeOk(c)&&!resolved(c.id)).length>0)return false;}
    return true;
  },[resolved,coreEvt,timeOk]);
  const isUnlocked=useCallback(t=>timeOk(t)&&depOk(t),[timeOk,depOk]);
  const dispName=useCallback(t=>{if(t.timeCondition){const p=toMin(ct)>=toMin(t.timeCondition.time);if(t.timeCondition.labelBefore&&!p)return t.timeCondition.labelBefore;if(t.timeCondition.labelAfter&&p)return t.timeCondition.labelAfter;}return t.name;},[ct]);
  const blockWhy=useCallback(task=>{
    const r=[];if(task.timeCondition&&!timeOk(task))r.push('At '+task.timeCondition.time);
    if(task.dependsOn&&!resolved(task.dependsOn)){const p=tasks.find(x=>x.id===task.dependsOn);if(p)r.push('After: '+p.name);}
    if(task.category==='work'||task.category==='personal'){const pn=coreEvt.filter(c=>timeOk(c)&&!resolved(c.id));if(pn.length>0)r.push('Pending: '+pn.map(c=>c.name).join(', '));}
    return r;
  },[timeOk,resolved,tasks,coreEvt]);

  const doComplete=id=>{setCompleted(p=>{const n={...p};n[id]?delete n[id]:(n[id]=true);return n;});setSkipped(p=>{const n={...p};delete n[id];return n;});};
  const doSkip=id=>{setSkipped(p=>{const n={...p};n[id]?delete n[id]:(n[id]=true);return n;});setCompleted(p=>{const n={...p};delete n[id];return n;});};
  const endDay=()=>{setCompleted({});setSkipped({});setConfirmEnd(false);notified.current.clear();};
  const delTask=id=>{setTasks(p=>p.filter(t=>t.id!==id).map(t=>t.dependsOn===id?{...t,dependsOn:null}:t));setCompleted(p=>{const n={...p};delete n[id];return n;});setSkipped(p=>{const n={...p};delete n[id];return n;});setConfirmDel(null);};
  const saveTask=td=>{if(td.id)setTasks(p=>p.map(t=>t.id===td.id?td:t));else setTasks(p=>[...p,{...td,id:genId(),order:p.length}]);setEditing(null);};
  const updateNotes=(id,notes)=>setTasks(p=>p.map(t=>t.id===id?{...t,notes}:t));
  const archiveTask=id=>setTasks(p=>p.map(t=>t.id===id?{...t,archived:true}:t));
  const unarchiveTask=id=>setTasks(p=>p.map(t=>t.id===id?{...t,archived:false}:t));
  const moveTask=(id,dir)=>{setTasks(p=>{const i=p.findIndex(t=>t.id===id);if(i<0)return p;const j=dir==='up'?i-1:i+1;if(j<0||j>=p.length)return p;const n=[...p];const tmp=n[i].order;n[i]={...n[i],order:n[j].order};n[j]={...n[j],order:tmp};[n[i],n[j]]=[n[j],n[i]];return n;});};

  const dayTasks=tasks.filter(t=>!t.archived&&isActive(t)&&(t.category==='core'||t.category==='event'||t.category===mode))
    .sort((a,b)=>{const at=a.timeCondition?toMin(a.timeCondition.time):9999;const bt=b.timeCondition?toMin(b.timeCondition.time):9999;return at!==bt?at-bt:a.order-b.order;});
  const nextTask=dayTasks.find(t=>!resolved(t.id)&&isUnlocked(t));

  if(loading)return h('div',{style:S.loadWrap},h('div',{style:{color:'#f59e0b'}},h(Ic.Moon)),h('p',{style:{color:'#94a3b8',marginTop:16}},'Loading...'));

  const renderCard=task=>{
    const done=!!completed[task.id],isSkip=!!skipped[task.id],res=done||isSkip,ul=isUnlocked(task);
    const reasons=blockWhy(task),name=dispName(task),c=CAT[task.category];
    const canSkip=(task.category==='core'||task.category==='event')&&ul&&!res;
    return h('div',{key:task.id,style:{...S.card,...(res?S.cardDone:{}),
      ...(!ul&&!res?S.cardLock:{}),borderLeftColor:c.border},onClick:()=>setViewing(task)},
      h('button',{style:{...S.cb,...(done?S.cbDone:{}),...(isSkip?S.cbSkip:{}),
        ...(!ul&&!res?S.cbLock:{})},onClick:e=>{e.stopPropagation();(ul||res)&&doComplete(task.id);},disabled:!ul&&!res},
        done&&h(Ic.Check),isSkip&&h(Ic.X),!ul&&!res&&h(Ic.Lock)),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{display:'flex',alignItems:'center',gap:8,flexWrap:'wrap'}},
          h('span',{style:{...S.tName,...(done?S.tDone:{}),...(isSkip?S.tSkipTxt:{}),
            ...(!ul&&!res?{color:'#475569'}:{})}},name),
          h('span',{style:{...S.badge,background:c.bg,color:c.text,borderColor:c.border}},c.label),
          task.notes&&h('span',{style:{color:'#475569',display:'flex'}},h(Ic.Note))),
        task.project&&h('div',{style:S.projLabel},task.project),
        !ul&&!res&&reasons.length>0&&h('div',{style:{display:'flex',flexDirection:'column',gap:2,marginTop:4}},
          reasons.map((r,i)=>h('span',{key:i,style:S.reason},h(Ic.Clock),' ',r))),
        isSkip&&h('span',{style:S.skipLbl},'Skipped')),
      canSkip&&h('button',{style:S.skipBtn,onClick:e=>{e.stopPropagation();doSkip(task.id);}},h(Ic.X)));
  };

  const rest=nextTask?dayTasks.filter(t=>t.id!==nextTask.id):dayTasks;
  const rCount=dayTasks.filter(t=>resolved(t.id)).length;
  const pct=dayTasks.length>0?rCount/dayTasks.length:0;
  const active=tasks.filter(t=>!t.archived);const archived=tasks.filter(t=>t.archived);
  const grouped={core:[],event:[],work:[],personal:[]};active.forEach(t=>{if(grouped[t.category])grouped[t.category].push(t);});

  return h('div',{style:S.root},
    banner&&h('div',{style:S.banner},h('span',{style:{fontSize:16}},'â°'),h('span',{style:S.bannerTxt},banner),h('button',{style:S.bannerX,onClick:()=>setBanner(null)},h(Ic.X))),
    h('div',{style:S.header},
      h('div',{style:{display:'flex',alignItems:'center',gap:12,flex:1}},
        h('span',{style:S.hTitle},tab==='day'?'My Day':'Manage'),
        h('span',{style:S.hTime},ct),
        h('span',{className:'sync-dot '+(synced?'sync-on':'sync-off'),title:synced?'Synced':'Offline'})),
      h('button',{style:{...S.notifBtn,color:notifOn?'#f59e0b':'#475569'},onClick:notifOn?()=>setNotifOn(false):reqNotif},notifOn?h(Ic.Bell):h(Ic.BellOff))),
    h('div',{style:S.content},
      tab==='day'?h('div',{style:{paddingBottom:80}},
        h('div',{style:{marginBottom:16}},h('div',{style:S.tglTrack},
          h('div',{style:{...S.tglThumb,transform:mode==='work'?'translateX(100%)':'translateX(0%)',background:mode==='personal'?'linear-gradient(135deg,#a855f7,#7c3aed)':'linear-gradient(135deg,#3b82f6,#2563eb)'}}),
          h('button',{style:{...S.tglOpt,color:mode==='personal'?'#fff':'#94a3b8'},onClick:()=>setMode('personal')},h(Ic.Sun),' Personal'),
          h('button',{style:{...S.tglOpt,color:mode==='work'?'#fff':'#94a3b8'},onClick:()=>setMode('work')},h(Ic.Brief),' Work'))),
        h('div',{style:S.progWrap},h('div',{style:S.progBg},h('div',{style:{...S.progFill,width:pct*100+'%',background:pct===1?'linear-gradient(90deg,#10b981,#34d399)':'linear-gradient(90deg,#f59e0b,#fbbf24)'}})),h('span',{style:S.progTxt},rCount+'/'+dayTasks.length)),
        nextTask&&h('div',{style:S.hero,onClick:()=>setViewing(nextTask)},
          h('div',{style:S.heroTop},h(Ic.Focus),h('span',{style:S.heroLabel},'FOCUS NOW')),
          h('div',{style:S.heroName},dispName(nextTask)),
          h('div',{style:S.heroMeta},h('span',{style:{...S.badge,background:CAT[nextTask.category].bg,color:CAT[nextTask.category].text,borderColor:CAT[nextTask.category].border}},CAT[nextTask.category].label),
            nextTask.project&&h('span',{style:S.heroProj},nextTask.project),nextTask.notes&&h('span',{style:{color:'#64748b',display:'flex',gap:3}},h(Ic.Note))),
          h('div',{style:S.heroBtns,onClick:e=>e.stopPropagation()},
            h('button',{style:S.heroDone,onClick:()=>doComplete(nextTask.id)},h(Ic.CheckBig),' Done'),
            (nextTask.category==='core'||nextTask.category==='event')&&h('button',{style:S.heroSkip,onClick:()=>doSkip(nextTask.id)},h(Ic.X),' Skip'))),
        pct===1&&h('div',{style:S.hero},h('div',{style:{...S.heroTop,color:'#34d399'}},h('span',{style:{fontSize:28}},'ðŸŽ‰')),h('div',{style:{...S.heroName,color:'#34d399',fontSize:22}},'All done!')),
        rest.length>0&&h('div',{style:{marginTop:12}},h('div',{style:S.secLabel},'Up ahead'),h('div',{style:{display:'flex',flexDirection:'column',gap:6}},rest.map(renderCard))),
        rCount>0&&h('button',{style:S.endBtn,onClick:()=>setConfirmEnd(true)},h(Ic.Moon),' End Day')
      ):h('div',{style:{paddingBottom:100}},
        ['core','event','work','personal'].map(cat=>{
          const list=grouped[cat];if(!list||!list.length)return null;const c=CAT[cat];
          return h('div',{key:cat,style:{marginBottom:24}},
            h('div',{style:{...S.aCatHead,color:c.text}},h('span',{style:{width:8,height:8,borderRadius:4,background:c.border,display:'inline-block'}}),c.label+' ('+list.length+')',
              (cat==='work'||cat==='personal')&&h('span',{style:S.aCatNote},'â†’ after Core & Events')),
            list.map((task,idx)=>h('div',{key:task.id,style:{...S.aCard,borderLeftColor:c.border}},
              h('div',{style:{flex:1,minWidth:0}},h('div',{style:S.aName},task.name),
                task.project&&h('div',{style:{fontSize:11,color:'#64748b',marginTop:2}},'ðŸ“ '+task.project),
                h('div',{style:{display:'flex',flexWrap:'wrap',gap:6,marginTop:4}},
                  task.timeCondition&&h('span',{style:S.aMeta},h(Ic.Clock),' '+task.timeCondition.time),
                  task.dependsOn&&h('span',{style:S.aMeta},h(Ic.Lock),' '+(tasks.find(x=>x.id===task.dependsOn)?.name||'?')),
                  task.category==='event'&&(task.eventDates||[]).length>0&&h('span',{style:S.aMeta},'ðŸ“… '+task.eventDates.join(', ')),
                  (task.activeDays||[]).length>0&&(task.activeDays||[]).length<7&&h('span',{style:S.aMeta},(task.activeDays||[]).map(d=>DAY_FULL[d]).join(', ')),
                  task.notes&&h('span',{style:{...S.aMeta,color:'#475569'}},h(Ic.Note),' notes'))),
              h('div',{style:{display:'flex',gap:3,flexShrink:0,flexWrap:'wrap',justifyContent:'flex-end',maxWidth:76}},
                h('button',{style:S.aBtn,onClick:()=>moveTask(task.id,'up'),disabled:idx===0},h(Ic.Up)),
                h('button',{style:S.aBtn,onClick:()=>moveTask(task.id,'down'),disabled:idx===list.length-1},h(Ic.Down)),
                h('button',{style:{...S.aBtn,color:'#60a5fa'},onClick:()=>setEditing(task)},h(Ic.Edit)),
                task.category==='event'?h('button',{style:{...S.aBtn,color:'#94a3b8'},onClick:()=>archiveTask(task.id)},h(Ic.Archive)):
                h('button',{style:{...S.aBtn,color:'#f87171'},onClick:()=>setConfirmDel(task.id)},h(Ic.Trash))))));
        }),
        archived.length>0&&h('div',{style:{marginTop:16}},
          h('button',{style:S.archiveToggle,onClick:()=>setShowArchived(!showArchived)},h(Ic.Archive),' Archived ('+archived.length+') ',showArchived?'â–¾':'â–¸'),
          showArchived&&archived.map(task=>h('div',{key:task.id,style:{...S.aCard,borderLeftColor:'#334155',opacity:0.6}},
            h('div',{style:{flex:1,minWidth:0}},h('div',{style:{...S.aName,textDecoration:'line-through'}},task.name)),
            h('div',{style:{display:'flex',gap:3}},
              h('button',{style:{...S.aBtn,color:'#60a5fa'},onClick:()=>unarchiveTask(task.id)},'â†©'),
              h('button',{style:{...S.aBtn,color:'#f87171'},onClick:()=>setConfirmDel(task.id)},h(Ic.Trash)))))),
        h('button',{style:S.fab,onClick:()=>setEditing('new')},h(Ic.Plus)))),
    h('div',{style:S.nav},
      h('button',{style:{...S.navBtn,...(tab==='day'?S.navAct:{})},onClick:()=>setTab('day')},h(Ic.Cal),h('span',{style:S.navLbl},'My Day')),
      h('button',{style:{...S.navBtn,...(tab==='admin'?S.navAct:{})},onClick:()=>setTab('admin')},h(Ic.Gear),h('span',{style:S.navLbl},'Manage'))),
    editing!==null&&h(TaskForm,{task:editing==='new'?null:editing,allTasks:tasks,onSave:saveTask,onClose:()=>setEditing(null)}),
    viewing!==null&&h(DetailSheet,{task:viewing,dispName:dispName(viewing),onClose:()=>setViewing(null),onUpdateNotes:n=>{updateNotes(viewing.id,n);setViewing({...viewing,notes:n});}}),
    confirmEnd&&h(ModalC,{title:'End Day',msg:'Reset all progress?',onOk:endDay,onNo:()=>setConfirmEnd(false),okLbl:'Reset',okClr:'#f59e0b'}),
    confirmDel&&h(ModalC,{title:'Delete',msg:'Delete "'+(tasks.find(t=>t.id===confirmDel)?.name||'')+'"?',onOk:()=>delTask(confirmDel),onNo:()=>setConfirmDel(null),okLbl:'Delete',okClr:'#ef4444'})
  );
}

// â•â•â• DETAIL SHEET â•â•â•
function DetailSheet({task,dispName,onClose,onUpdateNotes}){
  const [notes,setNotes]=useState(task.notes||'');const [dirty,setDirty]=useState(false);const c=CAT[task.category];
  return h('div',{style:S.overlay,onClick:onClose},h('div',{style:{...S.modal,maxWidth:440},onClick:e=>e.stopPropagation()},
    h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:4}},
      h('span',{style:{...S.badge,background:c.bg,color:c.text,borderColor:c.border,fontSize:10}},c.label),
      task.project&&h('span',{style:{fontSize:12,color:'#64748b'}},task.project)),
    h('h2',{style:{...S.mTitle,marginTop:8}},dispName),
    task.timeCondition&&h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:8,color:'#64748b',fontSize:12}},h(Ic.Clock),' '+task.timeCondition.time),
    task.category==='event'&&(task.eventDates||[]).length>0&&h('div',{style:{fontSize:12,color:'#fb7185',marginBottom:8}},'ðŸ“… '+task.eventDates.join(', ')),
    (task.activeDays||[]).length>0&&(task.activeDays||[]).length<7&&h('div',{style:{display:'flex',gap:4,marginBottom:12}},
      DAYS.map(d=>h('span',{key:d,style:{fontSize:10,fontWeight:700,padding:'3px 6px',borderRadius:5,
        background:(task.activeDays||[]).includes(d)?'rgba(251,191,36,0.15)':'transparent',
        color:(task.activeDays||[]).includes(d)?'#fbbf24':'#334155'}},DAY_LABELS[d]))),
    h('label',{style:S.fLabel},'Notes'),
    h('textarea',{style:{...S.fInput,minHeight:120,resize:'vertical',lineHeight:1.5},value:notes,onChange:e=>{setNotes(e.target.value);setDirty(true);},placeholder:'Add notes...'}),
    h('div',{style:{display:'flex',gap:10,marginTop:16}},h('button',{style:S.fCancel,onClick:onClose},'Close'),
      dirty&&h('button',{style:S.fSave,onClick:()=>{onUpdateNotes(notes);setDirty(false);}},'Save'))));
}

// â•â•â• TASK FORM â•â•â•
function TaskForm({task,allTasks,onSave,onClose}){
  const isE=!!task;
  const [name,setName]=useState(task?.name||'');const [category,setCat]=useState(task?.category||'core');
  const [project,setProj]=useState(task?.project||'');const [notes,setNotes]=useState(task?.notes||'');
  const [hasTime,setHT]=useState(!!task?.timeCondition);const [time,setTime]=useState(task?.timeCondition?.time||'08:00');
  const [lb,setLb]=useState(task?.timeCondition?.labelBefore||'');const [la,setLa]=useState(task?.timeCondition?.labelAfter||'');
  const [dep,setDep]=useState(task?.dependsOn||'');const [activeDays,setAD]=useState(task?.activeDays||[...ALL_DAYS]);
  const [eventDates,setED]=useState(task?.eventDates||[]);const [newDate,setNewDate]=useState('');
  const toggleDay=d=>setAD(p=>p.includes(d)?p.filter(x=>x!==d):[...p,d]);
  const addDate=()=>{if(newDate&&!eventDates.includes(newDate)){setED(p=>[...p,newDate].sort());setNewDate('');}};
  const submit=()=>{if(!name.trim())return;onSave({...(isE?task:{}),name:name.trim(),category,project:project.trim(),notes:notes.trim(),
    timeCondition:hasTime?{time,labelBefore:lb.trim()||null,labelAfter:la.trim()||null}:null,
    dependsOn:dep||null,activeDays:category==='event'?[]:activeDays,eventDates:category==='event'?eventDates:[],archived:task?.archived||false});};
  const projects=[...new Set(allTasks.map(t=>t.project).filter(Boolean))];
  return h('div',{style:S.overlay,onClick:onClose},h('div',{style:S.modal,onClick:e=>e.stopPropagation()},
    h('h2',{style:S.mTitle},isE?'Edit Task':'New Task'),
    h('label',{style:S.fLabel},'Name'),h('input',{style:S.fInput,value:name,onChange:e=>setName(e.target.value),placeholder:'Task name',autoFocus:true}),
    h('label',{style:S.fLabel},'Category'),h('select',{style:S.fSel,value:category,onChange:e=>setCat(e.target.value)},
      h('option',{value:'core'},'Core'),h('option',{value:'event'},'Event'),h('option',{value:'work'},'Work'),h('option',{value:'personal'},'Personal')),
    h('label',{style:S.fLabel},'Project'),h('input',{style:S.fInput,value:project,onChange:e=>setProj(e.target.value),placeholder:'Project name',list:'plist'}),
    h('datalist',{id:'plist'},projects.map(p=>h('option',{key:p,value:p}))),
    h('label',{style:S.fLabel},'Notes'),h('textarea',{style:{...S.fInput,minHeight:50,resize:'vertical'},value:notes,onChange:e=>setNotes(e.target.value),placeholder:'Context...'}),
    category!=='event'&&h('div',null,h('label',{style:S.fLabel},'Active Days'),
      h('div',{style:{display:'flex',gap:4,flexWrap:'wrap'}},DAYS.map(d=>h('button',{key:d,onClick:()=>toggleDay(d),style:{
        padding:'8px 12px',borderRadius:8,fontSize:12,fontWeight:700,fontFamily:F,cursor:'pointer',
        border:activeDays.includes(d)?'2px solid #f59e0b':'2px solid #1e293b',
        background:activeDays.includes(d)?'rgba(251,191,36,0.15)':'#0f172a',
        color:activeDays.includes(d)?'#fbbf24':'#475569'}},DAY_FULL[d])))),
    category==='event'&&h('div',null,h('label',{style:S.fLabel},'Dates'),
      h('div',{style:{display:'flex',gap:8,marginBottom:8}},h('input',{type:'date',style:{...S.fInput,flex:1},value:newDate,onChange:e=>setNewDate(e.target.value)}),
        h('button',{style:{...S.fSave,flex:'none',padding:'10px 16px'},onClick:addDate},'Add')),
      h('div',{style:{display:'flex',flexWrap:'wrap',gap:6}},eventDates.map(d=>h('span',{key:d,style:{display:'flex',alignItems:'center',gap:4,fontSize:12,background:'rgba(244,63,94,0.15)',color:'#fb7185',padding:'4px 10px',borderRadius:8,fontWeight:600}},
        d,h('button',{onClick:()=>setED(p=>p.filter(x=>x!==d)),style:{background:'none',border:'none',color:'#fb7185',cursor:'pointer',padding:0,display:'flex'}},h(Ic.X)))),
        eventDates.length===0&&h('span',{style:{fontSize:12,color:'#475569',fontStyle:'italic'}},'No dates'))),
    h('label',{style:S.fLabel},'Depends On'),h('select',{style:S.fSel,value:dep,onChange:e=>setDep(e.target.value)},
      h('option',{value:''},'None'),allTasks.filter(t=>t.id!==task?.id).map(t=>h('option',{key:t.id,value:t.id},t.name+' ('+CAT[t.category]?.label+')'))),
    (category==='work'||category==='personal')&&h('p',{style:S.fHint},'â„¹ï¸ Auto-waits for Core & Events.'),
    h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:16}},
      h('label',{style:S.fLabel},'Time'),h('button',{style:{...S.miniTgl,background:hasTime?'#f59e0b':'#334155'},onClick:()=>setHT(!hasTime)},
        h('div',{style:{...S.miniTh,transform:hasTime?'translateX(20px)':'translateX(2px)'}}))),
    hasTime&&h('div',{style:{background:'#0f172a',borderRadius:12,padding:'8px 14px 14px',marginTop:8}},
      h('label',{style:S.fLabelSm},'At'),h('input',{type:'time',style:S.fInput,value:time,onChange:e=>setTime(e.target.value)}),
      h('label',{style:S.fLabelSm},'Before label'),h('input',{style:S.fInput,value:lb,onChange:e=>setLb(e.target.value),placeholder:'Optional'}),
      h('label',{style:S.fLabelSm},'After label'),h('input',{style:S.fInput,value:la,onChange:e=>setLa(e.target.value),placeholder:'Optional'})),
    h('div',{style:{display:'flex',gap:10,marginTop:24}},h('button',{style:S.fCancel,onClick:onClose},'Cancel'),
      h('button',{style:S.fSave,onClick:submit,disabled:!name.trim()},isE?'Save':'Add'))));
}

// â•â•â• CONFIRM â•â•â•
function ModalC({title,msg,onOk,onNo,okLbl,okClr}){
  return h('div',{style:S.overlay,onClick:onNo},h('div',{style:{...S.modal,maxWidth:340},onClick:e=>e.stopPropagation()},
    h('h2',{style:S.mTitle},title),h('p',{style:{fontSize:14,color:'#94a3b8',lineHeight:1.5,margin:'0 0 20px'}},msg),
    h('div',{style:{display:'flex',gap:10}},h('button',{style:S.fCancel,onClick:onNo},'Cancel'),
      h('button',{style:{...S.fSave,background:okClr},onClick:onOk},okLbl))));
}

ReactDOM.createRoot(document.getElementById('root')).render(h(App));
</script>
</body>
</html>
